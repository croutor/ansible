---
- hosts: all
  remote_user: root

  vars:
    # Username
    user: croutor
    # email
    email: croutor@XXXXXX.com
    # fullname
    fullname: 'M. Croutor'
    # Timezone
    timezone: 'Europe/Paris'

  tasks:

    ###################
    # User Management
    ###################
    - name: Create user {{ user }}
      user: name={{ user }}
            comment="{{ user }} user"
            shell=/bin/bash

    - name: Add {{ user }} to sudoers
      template: src=templates/sudoers-user.j2
                dest=/etc/sudoers.d/{{ user }}-sudoer
                validate='visudo -cf %s'

    - name: Add my public key to {{ user }}
      authorized_key: user={{ user }}
                      key="{{ lookup('file', '~/.ssh/id_rsa.pub') }}"

    ###################
    # Time management
    ###################
    - name: Set local timezone
      copy: content={{ timezone }}
            dest=/etc/timezone
      notify: update tzdata

    - name: Install NTP (and update apt cache for the first install)
      apt: name=ntp state=present
           update_cache=yes

    - name: Start the ntp service
      service: name=ntp state=started enabled=true

    ###################
    # Debian packages
    ###################
    - name: Install Debian packages
      apt: name={{ item }} state=latest
      with_items:
        - mutt
        - esmtp
        - vim
        - htop
        - git
        - subversion
        - gitg
        - build-essential
        - valgrind
        - ddd
        - python-pip

    ###################
    # Python / Virtualenv
    ###################
    - name: Install virtualenv
      pip: name=virtualenv

    
    ###################
    # Vim config
    ###################
    - copy:
      src: config/vim/.vimrc
      dst: /home/{{user}}/.vimrc
      owner: "{{user}}"
      group: "{{user}}"

    ###################
    # mutt config
    ###################
    - template:
      src: config/mutt/.muttrc.j2
      dst: /home/{{user}}/.muttrc
      owner: "{{user}}"
      group: "{{user}}"
      mode: 0600

  ###################

  ###################
  # Handlers
  ###################
  handlers:
    - name: update tzdata
      command: /usr/sbin/dpkg-reconfigure --frontend noninteractive tzdata

